import { readdirSync, statSync, writeFileSync, existsSync, mkdirSync } from 'fs';
import { join, dirname, basename } from 'path';
import { fileURLToPath } from 'url';

const __dirname = dirname(fileURLToPath(import.meta.url));
const optimizedDir = join(__dirname, '../public/images-opt');
const originalDir = join(__dirname, '../public/images');
const outputFile = join(__dirname, '../src/data/lodges.ts');

// Check if optimized images exist
const useOptimized = existsSync(optimizedDir);
const imagesDir = useOptimized ? optimizedDir : originalDir;

console.log(`Using ${useOptimized ? 'optimized' : 'original'} images from: ${imagesDir}`);

// Extract category from folder name (everything before trailing numbers)
function extractCategory(folderName) {
  const match = folderName.match(/^(.+?)-?\d*$/);
  const base = match ? match[1].replace(/-\d+$/, '') : folderName;
  return base
    .split('-')
    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
    .join(' ');
}

// Convert folder name to display name
function toDisplayName(folderName) {
  return folderName
    .split('-')
    .map(word => {
      if (/^\d+$/.test(word)) return word;
      return word.charAt(0).toUpperCase() + word.slice(1);
    })
    .join(' ');
}

// Get image data for a lodge
function getImages(lodgeDir, lodgeId) {
  // Use relative paths (no leading /) so Vite's base path is respected
  const basePath = useOptimized ? 'images-opt' : 'images';

  if (useOptimized) {
    // Optimized: full images in root, thumbs in /thumb subfolder
    const files = readdirSync(lodgeDir)
      .filter(f => /\.(jpg|jpeg)$/i.test(f) && f !== 'thumb')
      .sort();

    return files.map(f => ({
      full: `${basePath}/${lodgeId}/${f}`,
      thumb: `${basePath}/${lodgeId}/thumb/${f}`
    }));
  } else {
    // Original: same file for both (no thumbnails)
    const files = readdirSync(lodgeDir)
      .filter(f => /\.(jpg|jpeg|png|gif|webp)$/i.test(f))
      .sort();

    return files.map(f => ({
      full: `${basePath}/${lodgeId}/${f}`,
      thumb: `${basePath}/${lodgeId}/${f}`
    }));
  }
}

// Main
const folders = readdirSync(imagesDir)
  .filter(f => statSync(join(imagesDir, f)).isDirectory())
  .sort((a, b) => {
    const catA = extractCategory(a);
    const catB = extractCategory(b);
    if (catA !== catB) return catA.localeCompare(catB);
    const numA = parseInt(a.match(/\d+$/)?.[0] || '0');
    const numB = parseInt(b.match(/\d+$/)?.[0] || '0');
    return numA - numB;
  });

const lodges = folders.map(folder => ({
  id: folder,
  name: toDisplayName(folder),
  category: extractCategory(folder),
  images: getImages(join(imagesDir, folder), folder)
}));

const categories = [...new Set(lodges.map(l => l.category))].sort();

const output = `// Auto-generated by scripts/generate-manifest.js
// Do not edit manually

export interface LodgeImage {
  full: string;
  thumb: string;
}

export interface Lodge {
  id: string;
  name: string;
  category: string;
  images: LodgeImage[];
}

export const lodges: Lodge[] = ${JSON.stringify(lodges, null, 2)};

export const categories: string[] = ${JSON.stringify(categories, null, 2)};

export function getLodgeById(id: string): Lodge | undefined {
  return lodges.find(l => l.id === id);
}

export function getLodgesByCategory(category: string): Lodge[] {
  return lodges.filter(l => l.category === category);
}
`;

mkdirSync(dirname(outputFile), { recursive: true });
writeFileSync(outputFile, output);
console.log(`Generated ${outputFile}`);
console.log(`- ${lodges.length} lodges`);
console.log(`- ${categories.length} categories: ${categories.join(', ')}`);
